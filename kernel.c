#include "io.h"

// 显存起始地址
#define 视频地址 0xb8000
// 屏幕最大行数和列数
#define 最大行数 25
#define 最大列数 80
// 白色文本黑色背景属性字节
#define 白色在黑色上 0x0f

// 打印单个字符到指定位置
void 打印字符(char character, int 列, int 行, char 属性字节);

// 在指定位置打印字符串
void 在指定位置打印(const char *消息, int 列, int 行);

// 打印字符串到屏幕
void 打印(const char *消息);

// 清空屏幕
void 清空屏幕();

// 获取键盘输入
char 获取按键();

// 终端功能
void 终端();

// 内核主函数
void 内核主函数() 
{
    清空屏幕();

    打印("欢迎使用 RedOS!\n");
    打印("启动终端...\n\n");
    
    终端();
    
    while (1);
}

// 终端功能
void 终端() 
{
    char 输入[256];
    int 索引 = 0;

    打印("RedOS> ");
 
    while (1) 
    {
        char 按键 = 获取按键();

        if (按键 == "\n") 
        {
            输入[索引] = "\0";

            打印("\n");
            
            // 简单的回显功能
            if (strcmp(输入, "clear") == 0) 
            {
                清空屏幕();
            } 
            else 
            {
                打印(输入);
                打印("\n");
            }

            索引 = 0;
            
            打印("RedOS ");
        } 
        else 
        {
            输入[索引++] = 按键;

            char 字符串[2] = {按键, "\0"};
            打印(字符串);
        }
    }
}

// 获取按键输入
char 获取按键() 
{
    char c = 0;

    while ((c = inb(0x60)) == 0);

    if (c > 0) return c;
    
    return "\0";
}

// 打印字符串到屏幕
void 打印(const char *消息) 
{
    在指定位置打印(消息, -1, -1);
}

// 在指定位置打印字符串
void 在指定位置打印(const char *消息, int 列, int 行) 
{
    int 偏移量;

    if (列 >= 0 && 行 >= 0) 
    {
        偏移量 = 行 * 最大列数 + 列;
    } 
    else 
    {
        偏移量 = -1;
    }

    while (*消息) 
    {
        打印字符(*消息++, 列, 行, 白色在黑色上);
    
        if (列 >= 0 && 行 >= 0) 
        {
            列++;
        
            if (列 >= 最大列数) 
            {
                列 = 0;
                行++;
            }
        }
    }
}

// 打印单个字符到指定位置
void 打印字符(char 字符, int 列, int 行, char 属性字节) 
{
    unsigned char *显存 = (unsigned char *)视频地址;

    if (!属性字节) 
    {
        属性字节 = 白色在黑色上;
    }

    if (列 >= 0 && 行 >= 0) 
    {
        int 偏移量 = 行 * 最大列数 + 列;
    
        显存[偏移量 * 2] = 字符;
        显存[偏移量 * 2 + 1] = 属性字节;
    } 
    else 
    {
        int 偏移量 = 0;
    
        while (显存[偏移量 * 2] != 0) 
        {
            偏移量++;
        }

        显存[偏移量 * 2] = 字符;
        显存[偏移量 * 2 + 1] = 属性字节;
    }
}

// 清空屏幕
void 清空屏幕() 
{
    for (int 行 = 0; 行 < 最大行数; 行++) 
    {
        for (int 列 = 0; 列 < 最大列数; 列++) 
        {
            打印字符(" ", 列, 行, 白色在黑色上);
        }
    }
}
